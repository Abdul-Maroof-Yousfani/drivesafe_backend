// Warranty Portal models

model Customer {
  id                String   @id @default(cuid())
  firstName         String
  lastName          String
  email             String
  phone             String
  address           String
  // Vehicle info moved to CustomerVehicle
  // vehicleMake       String
  // vehicleModel      String
  // vehicleYear       Int
  // vin               String?
  // registrationNumber String?
  // mileage           Int       @default(0)
  status            String    @default("active")
  createdById       String?
  createdBy         User?     @relation("CustomerCreatedBy", fields: [createdById], references: [id])
  dealerId          String?
  dealer            Dealer?   @relation(fields: [dealerId], references: [id], onDelete: SetNull)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  vehicles          CustomerVehicle[]
  warrantySales     WarrantySale[]
  documents         CustomerDocument[]
  
  @@index([email])
  @@index([phone])
  @@index([dealerId])
}

model Dealer {
  id                      String   @id @default(cuid())
  businessNameLegal      String
  businessNameTrading    String?
  businessAddress         String
  contactPersonName       String
  phone                   String
  email                   String   @unique
  dealerLicenseNumber     String?
  businessRegistrationNumber String?
  bankDetails             String?   // JSON string for bank details
  authorizedSignatory     String?   // JSON string for signatory details
  dealerAgreementSigned   Boolean   @default(false)
  onboardingDate          DateTime?
  password                String
  status                  String    @default("active")
  
  // Tenant database fields
  databaseName            String?   @unique  // Name of dealer's database (e.g., dealer_abc123)
  databaseUrl             String?            // Full connection string for dealer database
  username                String?            // Auto-generated username for dealer login
  databaseUsername        String?            // Restricted DB user for dealer database
  databasePassword        String?            // Restricted DB user password (encrypted at rest)
  credentialsGeneratedAt  DateTime?          // Timestamp when credentials were generated
  excelFilePath           String?            // Path to Excel file containing credentials
  
  createdById             String?
  createdBy               User?     @relation("DealerCreatedBy", fields: [createdById], references: [id])
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  customers               Customer[]
  warrantySales           WarrantySale[]
 
  warrantyAssignments     WarrantyAssignment[]
  tenantDatabaseMapping   TenantDatabaseMapping?  @relation("DealerTenantMapping")
  invoiceTemplate         InvoiceTemplate?
  invoices                Invoice[]                @relation("DealerInvoices")
  dealerStorage           DealerStorage?
  
  @@index([email])
  @@index([phone])
  @@index([databaseName])
  documents               CustomerDocument[]
}

model InvoiceTemplate {
  id              String   @id @default(cuid())
  // Relation to Dealer (if null, it is the Master/SA template)
  dealerId        String?  @unique
  dealer          Dealer?  @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  
  // Customization Fields
  companyName     String?  // Override business name if needed
  companyAddress  String?  // Override address
  logoUrl         String?
  logoOffsetX     Int      @default(0)
  logoOffsetY     Int      @default(0)
  invoiceInfoOffsetX Int   @default(0)
  invoiceInfoOffsetY Int   @default(0)
  companyInfoOffsetX Int   @default(0)
  companyInfoOffsetY Int   @default(0)
  billToOffsetX     Int      @default(0)
  billToOffsetY     Int      @default(0)
  durationOffsetX   Int      @default(0)
  durationOffsetY   Int      @default(0)
  notesOffsetX      Int      @default(0)
  notesOffsetY      Int      @default(0)
  termsOffsetX      Int      @default(0)
  termsOffsetY      Int      @default(0)
  footerOffsetX     Int      @default(0)
  footerOffsetY     Int      @default(0)
  primaryColor    String   @default("#000000") // Hex color
  accentColor     String   @default("#e5e7eb")
  font            String   @default("Helvetica")
  
  // Content
  headerText      String?
  billToTitle     String   @default("Bill To:")
  notesHeading    String?  @default("Notes")
  footerText      String?
  notes           String?  // e.g. "Thank you for your business"
  termsHeading    String?  @default("Terms & Conditions")
  termsText       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([dealerId])
}

model WarrantyPackage {
  id                String   @id @default(cuid())
  name              String
  description       String?
  planLevel         String?
  /// Optional reference key for dynamic plan levels (e.g. Silver, Gold)
  // planLevel is kept as free text; dynamic plan levels are managed via WarrantyPlanLevel
  eligibility       String?
  eligibilityMileageComparator String?
  eligibilityMileageValue      Int?
  eligibilityVehicleAgeYearsMax Int?
  eligibilityTransmission      String?
  excess            Decimal?
  labourRatePerHour Decimal?
  fixedClaimLimit   Decimal?
  price12Months     Decimal?
  price24Months     Decimal?
  price36Months     Decimal?
  /// Dealer internal prices (cost to dealer when SA assigns package)
  dealerPrice12Months  Decimal?
  dealerPrice24Months  Decimal?
  dealerPrice36Months  Decimal?
  /// Total coverage duration in months (normalized)
  coverageDuration  Int
  /// The raw duration value entered by admin (e.g. 12)
  durationValue     Int
  /// Unit for duration: "months" or "years"
  durationUnit      String   @default("months")
  /// Context: "drive_safe" | "dealer" | "direct_customer"
  context           String   @default("drive_safe")
  /// Base price (required for drive_safe context, optional otherwise)
  price             Decimal?
  /// Whether this is a preset template (Silver, Gold, Platinum, etc.)
  isPreset          Boolean  @default(false)
  /// Preset type: "silver" | "gold" | "platinum" | null (for custom packages)
  presetType        String?
  status            String    @default("active")
  createdById       String?
  createdBy         User?     @relation("WarrantyPackageCreatedBy", fields: [createdById], references: [id])
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?
  
  warrantySales     WarrantySale[]
  warrantyAssignments WarrantyAssignment[]
  items             WarrantyPackageItem[]
  
  @@index([isPreset])
  @@index([presetType])
}

/// Master definition of dynamic warranty plan levels (e.g. Silver, Gold, Platinum)
model WarrantyPlanLevel {
  id          String                     @id @default(cuid())
  name        String                     @unique
  description String?
  status      String                     @default("active")
  createdAt   DateTime                   @default(now())
  updatedAt   DateTime                   @updatedAt

  benefits    WarrantyPlanLevelBenefit[]

  @@index([status])
}

/// Mapping of plan levels to their default warranty items (benefits)
model WarrantyPlanLevelBenefit {
  id           String           @id @default(cuid())
  planLevelId  String
  planLevel    WarrantyPlanLevel @relation(fields: [planLevelId], references: [id], onDelete: Cascade)
  warrantyItemId String
  warrantyItem WarrantyItem     @relation(fields: [warrantyItemId], references: [id], onDelete: Cascade)

  @@unique([planLevelId, warrantyItemId])
  @@index([planLevelId])
  @@index([warrantyItemId])
}

model WarrantyPackageItem {
  id                String          @id @default(cuid())
  warrantyPackageId String
  warrantyPackage   WarrantyPackage @relation(fields: [warrantyPackageId], references: [id], onDelete: Cascade)
  warrantyItemId    String
  warrantyItem      WarrantyItem    @relation(fields: [warrantyItemId], references: [id], onDelete: Cascade)
  type              String          @default("benefit") // "benefit" or "feature"

  @@unique([warrantyPackageId, warrantyItemId, type])
  @@index([warrantyPackageId])
  @@index([warrantyItemId])
}

model WarrantySale {
  id                      String        @id @default(cuid())
  customerId              String?
  customer                Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  dealerId                String?
  dealer                  Dealer?       @relation(fields: [dealerId], references: [id], onDelete: SetNull)
  salesRepresentativeName String?

  warrantyPackageId       String
  warrantyPackage         WarrantyPackage @relation(fields: [warrantyPackageId], references: [id])
  vehicleId               String?
  vehicle                 CustomerVehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  coverageStartDate       DateTime
  coverageEndDate         DateTime
  
  // Snapshot fields: capture package info at sale time for immutability
  packageName             String
  planLevel               String?
  packageDescription      String?
  packageEligibility      String?
  planMonths              Int
  dealerName              String?       // Capture dealer name at sale time
  
  warrantyPrice           Decimal
  excess                  Decimal?
  labourRatePerHour       Decimal?
  fixedClaimLimit         Decimal?
  
  // Snapshotted package prices at sale
  price12Months           Decimal?
  price24Months           Decimal?
  price36Months           Decimal?

  // Dealer cost fields (for margin visibility)
  dealerCost12Months      Decimal?
  dealerCost24Months      Decimal?
  dealerCost36Months      Decimal?
  
  paymentMethod           String
  saleDate                DateTime
  customerConsent         Boolean       @default(false)
  mileageAtSale           Int?
  customerSignature       String?       // Reference to uploaded signature file
  policyNumber            String        @unique
  status                  String        @default("active")
  createdById             String?
  createdBy               User?         @relation("WarrantySaleCreatedBy", fields: [createdById], references: [id])
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt

  invoices                Invoice[]
  benefits                WarrantySaleBenefit[]

  @@index([customerId])
  @@index([vehicleId])
  @@index([dealerId])
  
  @@index([policyNumber])
  @@index([saleDate])
}

model WarrantyAssignment {
  id                String          @id @default(cuid())
  dealerId          String
  dealer            Dealer          @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  warrantyPackageId String
  warrantyPackage   WarrantyPackage @relation(fields: [warrantyPackageId], references: [id])
  
  price             Decimal
  dealerPrice12Months Decimal?
  dealerPrice24Months Decimal?
  dealerPrice36Months Decimal?
  
  paymentMethod     String?
  assignedAt        DateTime        @default(now())
  
  assignedById      String?
  assignedBy        User?           @relation("WarrantyAssignmentAssignedBy", fields: [assignedById], references: [id])

  invoices          Invoice[]

  @@index([dealerId])
  @@index([warrantyPackageId])
}

/// Perâ€‘sale snapshot of selected warranty benefits
model WarrantySaleBenefit {
  id             String       @id @default(cuid())
  warrantySaleId String
  warrantySale   WarrantySale @relation(fields: [warrantySaleId], references: [id], onDelete: Cascade)
  warrantyItemId String
  warrantyItem   WarrantyItem @relation(fields: [warrantyItemId], references: [id])
  label          String?       // Snapshot of warrantyItem.label at sale time
  type           String       @default("benefit") // Snapshot of warrantyItem.type at sale time

  @@index([warrantySaleId])
  @@index([warrantyItemId])
}

model Invoice {
  id              String       @id @default(cuid())
  invoiceNumber   String       @unique
  warrantySaleId  String?
  warrantySale    WarrantySale? @relation(fields: [warrantySaleId], references: [id], onDelete: Cascade)
  warrantyAssignmentId String?
  warrantyAssignment WarrantyAssignment? @relation(fields: [warrantyAssignmentId], references: [id], onDelete: Cascade)
  dealerId        String?
  dealer          Dealer?      @relation("DealerInvoices", fields: [dealerId], references: [id], onDelete: SetNull)
  amount          Decimal      // Amount dealer owes to SA (dealer cost)
  status          String       @default("pending") // pending, paid, overdue, cancelled
  invoiceDate     DateTime     @default(now())
  dueDate         DateTime
  paidDate        DateTime?
  paymentMethod   String?      // cash, bank_transfer, cheque, etc.
  notes           String?
  createdById     String?
  createdBy       User?        @relation("InvoiceCreatedBy", fields: [createdById], references: [id])
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([warrantySaleId])
  @@index([dealerId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([invoiceDate])
  @@index([dueDate])
}

model CustomerVehicle {
  id                 String   @id @default(cuid())
  customerId         String
  customer           Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  make               String
  model              String
  year               Int
  vin                String?
  registrationNumber String?
  mileage            Int      @default(0)
  transmission       String?
  // DVLA vehicle enquiry snapshot fields
  dvlaTaxStatus             String?
  dvlaTaxDueDate            DateTime?
  dvlaMotStatus             String?
  dvlaMotExpiryDate         DateTime?
  dvlaYearOfManufacture     Int?
  dvlaEngineCapacity        Int?
  dvlaCo2Emissions          Int?
  dvlaFuelType              String?
  dvlaMarkedForExport       Boolean?
  dvlaColour                String?
  dvlaTypeApproval          String?
  dvlaDateOfLastV5CIssued   DateTime?
  dvlaWheelplan             String?
  dvlaMonthOfFirstRegistration String?
  status             String   @default("active")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  warrantySales     WarrantySale[]

  @@index([customerId])
  @@index([vin])
}

model WarrantyItem {
  id        String   @id @default(cuid())
  label     String
  description String?
  type      String   @default("benefit")
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  planLevelBenefits   WarrantyPlanLevelBenefit[]
  saleBenefits        WarrantySaleBenefit[]
  
  
  packageItems WarrantyPackageItem[]

  @@index([type])
}

model CustomerDocument {
  id               String   @id @default(cuid())
  name             String
  description      String?
  fileId           String
  file             FileUpload @relation(fields: [fileId], references: [id])
  customerId       String
  customer         Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  dealerId         String?
  dealer           Dealer?  @relation(fields: [dealerId], references: [id], onDelete: SetNull)
  createdById      String?
  createdBy        User?    @relation("DocumentUploadedBy", fields: [createdById], references: [id])
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([customerId])
  @@index([dealerId])
  @@index([createdById])
}

model DealerStorage {
  id              String   @id @default(cuid())
  dealerId        String   @unique
  dealer          Dealer   @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  usedBytes       BigInt   @default(0)
  limitBytes      BigInt   @default(1073741824) // 1GB in bytes
  lastCalculated  DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([dealerId])
}
